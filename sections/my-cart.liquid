<div class="cart-total" style="display: none;">
  <div data-ajax-cart-bind-state="cart.total_price | money_with_currency" class="cart-total-value">
  {{ cart.total_price | money_with_currency }}
</div>
</div>
<form class="height-full pf-form-processed flex direction-column form-wrapper" action="{{ routes.cart_url }}" method="post">
  <div class="flex justify-between items-center cart-header">
  <h2 class="cart-title m-0">Demo Cart for Sedan</h2>
  <button data-ajax-cart-toggle-class-button="js-my-cart-open | remove" class="cart-close-button absolute">
    X
  </button>
</div>
<div class="free-shipping">
  {% assign threshold = 75 | times: 100 %}
  {% assign value_left = threshold | minus:cart.total_price %}
  {% assign value_left_money = value_left | money %}
    <h4>WANT FREE DELIVERY?</h4>
    {% if value_left <= 0 %}
    <div class="shipping-message">You qualify for free shipping ðŸŽ‰</div>
    {% else %}
    <div class="shipping-message">Just spend another {{ value_left_money }} to get free shipping!</div>
    {% endif %}
    <div class="shipping-bar-container">
    <div class="shipping-bar"></div>
    </div>
</div>
<div class="my-cart relative flex direction-column h-full" data-ajax-cart-section>

    <div class="flex direction-column overflow-y-scroll overflow-x-hidden">
        {% if cart.item_count > 0 %}
        {% for item in cart.items %}
        <div class="my-cart__item h-fit-content">
        <div class="flex cart-item-container">

            
        <div class="slide-cart-image">
            <img src="{{ item.image | img_url: 'medium' }}" width="{{ item.image.width }}" height="{{ item.image.height }}" alt="{{ item.image | escape }}" loading="lazy">
        </div> 
   
        <div class="cart-info flex direction-column">
            <a href="{{ item.url }}"><p class="slide-cart-title">{{ item.product.title }}</p></a>              
        <div class="variant_price">
            <div class="slide_price">{{ item.final_line_price | money | remove: '.00' }}</strong></div>
        </div>
        {%- assign itemDiscounts = 'template ' | split: ' ' -%}
        {%- if item.line_level_discount_allocations != blank -%}
            {%- assign itemDiscounts = item.line_level_discount_allocations -%}
        {%- endif -%}

        <div class="order-discount order-discount--list order-discount--title order-discount--cart{% if item.line_level_discount_allocations == blank %} hide{% endif %}" aria-label="{{ 'customer.order.discount' | t }}" data-cart-item-discount-list>
        {%- for discount_allocation in itemDiscounts -%}
            <li class="order-discount__item" data-cart-item-discount>
            {% include 'icon-saletag' %}
            <span data-cart-item-discount-title>
                {{- discount_allocation.discount_application.title -}}
            </span> (-<span data-cart-item-discount-amount>{{ discount_allocation.amount | money }}</span>)
            </li>
        {%- endfor -%}
        </div>

        <div class="flex justify-between items-center cart-item-buttons">
            <div class="qtyButtonWrapSlideCart">
            <div class="qty-button-wrap-slide flex justify-between" style="align-items: center; height: 38px">
            
            <a data-ajax-cart-request-button class="minus underline-0 flex justify-center items-end" href="{{ routes.cart_change_url }}?line={{ forloop.index }}&quantity={{ item.quantity | minus: 1 }}">
                <svg width="6" height="2" viewBox="0 0 6 2" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M1.288 1.388C1.19467 1.388 1.11533 1.36 1.05 1.304C0.994 1.23867 0.966 1.15933 0.966 1.066V0.534C0.966 0.440666 0.994 0.366 1.05 0.31C1.11533 0.244667 1.19467 0.212 1.288 0.212H5.488C5.58133 0.212 5.656 0.244667 5.712 0.31C5.77733 0.366 5.81 0.440666 5.81 0.534V1.066C5.81 1.15933 5.77733 1.23867 5.712 1.304C5.656 1.36 5.58133 1.388 5.488 1.388H1.288Z" fill="black"/>
                </svg>
            </a>
            <input data-ajax-cart-quantity-input="{{ forloop.index }}" value="{{ item.quantity }}" name="updates[]" id="updates_{{ forloop.index }}"/>
            <a data-ajax-cart-request-button class="plus underline-0 flex justify-center items-end" href="{{ routes.cart_change_url }}?line={{ forloop.index }}&quantity={{ item.quantity | plus: 1 }}">
                <svg width="9" height="8" viewBox="0 0 9 8" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M4.102 7.538C4.00867 7.538 3.92933 7.51 3.864 7.454C3.808 7.38867 3.78 7.30933 3.78 7.216V4.304H0.91C0.816667 4.304 0.737333 4.276 0.672 4.22C0.616 4.15467 0.588 4.07533 0.588 3.982V3.534C0.588 3.44067 0.616 3.366 0.672 3.31C0.737333 3.24467 0.816667 3.212 0.91 3.212H3.78V0.384C3.78 0.290666 3.808 0.216 3.864 0.16C3.92933 0.0946664 4.00867 0.0619996 4.102 0.0619996H4.592C4.68533 0.0619996 4.76 0.0946664 4.816 0.16C4.88133 0.216 4.914 0.290666 4.914 0.384V3.212H7.798C7.89133 3.212 7.966 3.24467 8.022 3.31C8.08733 3.366 8.12 3.44067 8.12 3.534V3.982C8.12 4.07533 8.08733 4.15467 8.022 4.22C7.966 4.276 7.89133 4.304 7.798 4.304H4.914V7.216C4.914 7.30933 4.88133 7.38867 4.816 7.454C4.76 7.51 4.68533 7.538 4.592 7.538H4.102Z" fill="black"/>
                </svg>
            </a>
            </div>
        </div>
        <div class="remove-cart">
            <a class="slide_cart_remove underline-0" data-ajax-cart-request-button href="{{ routes.cart_change_url }}?id={{ item.key }}&quantity=0">REMOVE</a></div>
        </div>   
    </div>
    </div>
    <div data-ajax-cart-messages="{{ item.key }}"></div>
</div>
    {% endfor %}

    {% else %}

    <div class="text-center">
        <p>There are no items here</p>
    </div>
    {% endif %}
</div>

<div class="slide-cart-footer mt-auto pt-25">
    <div class="flex justify-between subtotal-wrapper">
    <div class="subtotal">SUBTOTAL</div>
    <div class="subtotal-price">{{ cart.total_price | money }}</div>
    </div>

    <a href="/checkout" class="button w-full text-center view-cart">
    CHECKOUT
    </a>

    <p class="button w-full text-center checkout-button" >Continue Shopping</p>

</div>

</div>
  </form>

  <script>

    window.addEventListener("load", (event) => {

      const shippingBar = document.querySelector('.shipping-bar')
      const priceContainer = document.querySelector('.cart-total')

      // Calculate current percentage of treshold
      let threshold = 75.00
      let cartTotalStr = document.querySelector('.cart-total-value').innerHTML
      let cartTotal =  parseFloat(cartTotalStr.match(/[\d\.]+/))

      // Set width to be equal to percentage
      let currentProgress = ((cartTotal / threshold) * 100)
      if (currentProgress <= 100) {
        shippingBar.style.width = `${currentProgress}%`
      } else {
        shippingBar.style.width = `100%`
      }

  
      // Use mutation observer to dynamically update cart based on cart changes
      const mutationObserver = new MutationObserver(mutationRecords => {
        let threshold = 75.00

        let cartTotalStr = document.querySelector('.cart-total-value').innerHTML
        let cartTotal =  parseFloat(cartTotalStr.match(/[\d\.]+/))

        if (threshold <= cartTotal) {
          document.querySelector('.shipping-message').innerHTML = 'You qualify for free shipping ðŸŽ‰'
          shippingBar.style.width = '100%'
        } else {
          let remainder = (threshold - cartTotal).toFixed(2)
          document.querySelector('.shipping-message').innerHTML = `Just spend another Â£${remainder} to get free shipping!`
          let currentProgress = ((cartTotal / threshold) * 100)
          shippingBar.style.width = `${currentProgress}%`
        }
      });
  
      // observe changes to cart price
      mutationObserver.observe(priceContainer, {
        childList: true,
        subtree: true,
        characterData: true
      })
});
  </script>
